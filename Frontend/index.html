<!DOCTYPE html>
<html lang="en">
    <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>WebSocket JSON Sender</title> 
            
            <style>
                /* Стили для lobbyTextInfo */
                #lobbyContainer {
                    font-size: 20px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    padding: 10px;    
                }
            </style>

        </head>
<body>
    <textarea id="chatMessageInput" rows="5" cols="50">
        {
            "type": "ChatMessage",  
            "text": "Hello, world!"
        }
    </textarea>
    <br>
    <button onclick="sendChatMessage()">Отправить ChatMessage JSON</button>
    <br><br>

    <textarea id="positionInput" rows="5" cols="50">
        {
            "type": "Position", 
            "x": 11,
            "y": 22
        }
    </textarea>
    <br>
    <button onclick="sendPosition()">Отправить Canvas JSON</button>
    <br><br>

    <textarea id="lobbyCommand" rows="5" cols="50">
        {
            "type": "LobbyCommand", 
            "LobbyName": "lobby#1"
        }
    </textarea>
    <br>
    <button onclick="sendLobbyCommand()">Отправить LobbyCommand JSON</button>
    <br><br>

    <div class="container">
        <div class="left-panel">  
            <div id="lobbyContainer">
                <div id="lobbyTextInfo">Текущее лобби</div>
                <select id="lobbySelect"></select>
                <button onclick="sendSelectedLobby()">Сменить лобби</button>
            </div>
        </div>
        <div class="right-panel">  
            <textarea id="chatMessagesDisplay" rows="19" cols="50" readonly></textarea>  
            <canvas id="canvas" width="400" height="300" style="border: 1px solid #000;"></canvas>  
        </div>
    </div>
     
    <script>
        const socket = new WebSocket('ws://localhost:8080/ws');
        const canvas = document.getElementById('canvas');
        const lobbyTextInfo = document.getElementById('lobbyTextInfo');
 
// Функция для отправки ChatMessage
function sendChatMessage() {
    const chatMessageInput = document.getElementById('chatMessageInput').value;

    try {
        const chatMessageJson = JSON.parse(chatMessageInput);
        console.log('Отправляемый ChatMessage JSON:', chatMessageJson); // Добавленная строка

        socket.send(JSON.stringify(chatMessageJson));
        console.log('Отправлено ChatMessage:', chatMessageJson);
    } catch (error) {
        console.error('Ошибка при отправке ChatMessage:', error);
    }
}

// Функция для отправки Canvas
function sendPosition() {
    const positionInput = document.getElementById('positionInput').value;

    try {
        const positionInputJson = JSON.parse(positionInput);
        console.log('Отправляемый PositionInput JSON:', positionInputJson); // Добавленная строка

        socket.send(JSON.stringify(positionInputJson));
        console.log('Отправлено PositionInput:', positionInputJson);
    } catch (error) {
        console.error('Ошибка при отправке PositionInput:', error);
    }
}

// Функция для отправки LobbyCommand
function sendLobbyCommand() {
    const lobbyCommandInput = document.getElementById('lobbyCommand').value;

    try {
        const lobbyCommandInputJson = JSON.parse(lobbyCommandInput);
        console.log('Отправляемый lobbyInput JSON:', lobbyCommandInputJson); // Добавленная строка

        socket.send(JSON.stringify(lobbyCommandInputJson));
        console.log('Отправлено lobbyInput:', lobbyCommandInputJson);
    } catch (error) {
        console.error('Ошибка при отправке lobbyInput:', error);
    }
}

        // Остальной код для обработки WebSocket остается тем же
        // ...
         // Добавляем обработчик события клика на канвасе
        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            const positionData = {
                type: 'Position',
                x: x,
                y: y
            };

            try {
                socket.send(JSON.stringify(positionData));
                console.log('Отправлены координаты клика:', positionData);
            } catch (error) {
                console.error('Ошибка при отправке координат клика:', error);
            }
        });

        // Функция для заполнения списка активных лобби
        function fillLobbySelect(lobbyNames) {
            const lobbySelect = document.getElementById('lobbySelect');
            lobbySelect.innerHTML = ''; // Очищаем текущие опции

            lobbyNames.forEach(lobbyName => {
                const option = document.createElement('option');
                option.value = lobbyName;
                option.textContent = lobbyName;
                lobbySelect.appendChild(option);
            }); 
        }

        // Функция для отправки выбранного лобби на сервер
        function sendSelectedLobby() {
            const lobbySelect = document.getElementById('lobbySelect');
            const selectedLobby = lobbySelect.value;

            const lobbyCommand = {
                type: 'LobbyCommand',
                LobbyName: selectedLobby
            };

            try {
                socket.send(JSON.stringify(lobbyCommand));
                console.log('Отправлен выбранный лобби:', lobbyCommand);  
            } catch (error) {
                console.error('Ошибка при отправке выбранного лобби:', error);
            }
        }

        socket.onmessage = function(event) {
            const message = JSON.parse(event.data); 
            const messageType = message.type;

            if (messageType === 'ChatMessageData') {
                // Создаем строку с данными сообщения
                const chatMessagesDisplay = document.getElementById('chatMessagesDisplay');
                const messageContent = `${message.username}: ${message.text}: ${message.date}`;

                // Устанавливаем строку с данными сообщения в текстовое поле chatMessagesDisplay
                chatMessagesDisplay.value += messageContent + '\n';
            }
            
            if (messageType === 'CanvasMessageData') {
                // Очистка канваса
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Обработка каждой позиции в сообщении
                message.positions.forEach(position => {
                    // Рисование куба по координатам
                    ctx.fillStyle = 'black';
                    ctx.fillRect(position.x - 10, position.y - 10, 20, 20);

                    // Отображение имени пользователя над кубом// Отображение имени пользователя над кубом
                    ctx.font = "10px Arial";  
                    ctx.fillText(position.username, position.x - 15, position.y - 15); // Корректировка координат для отображения текста над кубом

                });
            }
             

            if (messageType === 'LobbiesNamesData') {
                const lobbyNames = message.lobby_names;
                fillLobbySelect(lobbyNames); // Заполняем список активных лобби 
                lobbyTextInfo.textContent = message.current_lobby; 
            }
        }
    </script>
</body>
</html>
